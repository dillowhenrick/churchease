services:
  ###########################################
  # Application Container (PHP-FPM)
  ###########################################
  app:
    build:
      context: .
      dockerfile: ./.docker/app/Dockerfile
      target: development
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    container_name: churchease_app
    restart: unless-stopped
    environment:
      TZ: ${TZ:-UTC}
      APP_TIMEZONE: ${APP_TIMEZONE:-Asia/Manila}
      PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT:-512M}
    volumes:
      # Application code (for development hot-reload)
      - .:/var/www/app:cached
      # Persistent storage for uploads (media library)
      - storage_app_data:/var/www/app/storage/app
    ports:
      - "${VITE_PORT:-5173}:5173"
    networks:
      - churchease-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Development resource limits (soft reservations only)
    deploy:
      resources:
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  ###########################################
  # Web Server (Nginx)
  ###########################################
  nginx:
    image: nginx:1.27-alpine
    container_name: churchease_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-8000}:80"
    volumes:
      # Application code
      - .:/var/www/app
      # Nginx configuration
      - ./.docker/server/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - churchease-network
    depends_on:
      - app
    # Development resource limits (soft reservations only)
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  ###########################################
  # Database (PostgreSQL)
  ###########################################
  postgres:
    image: postgres:17-alpine
    container_name: churchease_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE:-churchease}
      POSTGRES_USER: ${DB_USERNAME:-churchease}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-churchease}
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: ${TZ:-UTC}
    command:
      - "postgres"
      - "-c"
      - "timezone=UTC"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - churchease-network
    # Development resource limits (soft reservations only)
    deploy:
      resources:
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-churchease} -d ${DB_DATABASE:-churchease}"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s
    # Expose port only in development (override in production)
    ports:
      - "${DB_PORT:-5432}:5432"

  ###########################################
  # Cache/Queue (Redis)
  ###########################################
  redis:
    image: redis:7-alpine
    container_name: churchease_redis
    restart: unless-stopped
    command:
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD:-churchease}"
      - "--maxmemory"
      - "256mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--appendonly"
      - "yes"
    volumes:
      - redis_data:/data
    networks:
      - churchease-network
    # Development resource limits (soft reservations only)
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-churchease}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    # Expose port only in development (override in production)
    ports:
      - "${REDIS_PORT:-6379}:6379"

  ###########################################
  # Email Testing (Mailpit)
  ###########################################
  mailpit:
    image: axllent/mailpit:v1.21
    container_name: churchease_mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_HTTP_PORT:-8025}:8025"  # Web UI
      - "${MAILPIT_SMTP_PORT:-1025}:1025"  # SMTP server
    networks:
      - churchease-network
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    volumes:
      - mailpit_data:/data
    # Development resource limits
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 32M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025/api/v1/info"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  ###########################################
  # Database Admin (Adminer)
  ###########################################
  adminer:
    image: adminer:4-standalone
    container_name: churchease_adminer
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    networks:
      - churchease-network
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      - postgres
    # Development resource limits
    deploy:
      resources:
        reservations:
          cpus: '0.05'
          memory: 32M
    healthcheck:
      test: ["CMD", "php", "-r", "exit(0);"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  ###########################################
  # Laravel Horizon (Queue Management)
  ###########################################
  horizon:
    build:
      context: .
      dockerfile: ./.docker/app/Dockerfile
      target: development
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    container_name: churchease_horizon
    restart: unless-stopped
    command: php artisan horizon
    environment:
      TZ: ${TZ:-UTC}
      APP_TIMEZONE: ${APP_TIMEZONE:-Asia/Manila}
    volumes:
      - .:/var/www/app:cached
    networks:
      - churchease-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${HORIZON_PORT:-8888}:8888"
    deploy:
      resources:
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[h]orizon' || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  ###########################################
  # Laravel Scheduler
  ###########################################
  scheduler:
    build:
      context: .
      dockerfile: ./.docker/app/Dockerfile
      target: development
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    container_name: churchease_scheduler
    restart: unless-stopped
    command: >
      sh -c "while true; do
        php artisan schedule:run --verbose --no-interaction &
        sleep 60
      done"
    environment:
      TZ: ${TZ:-UTC}
      APP_TIMEZONE: ${APP_TIMEZONE:-Asia/Manila}
    volumes:
      - .:/var/www/app:cached
    networks:
      - churchease-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[s]chedule:run' || exit 1"]
      interval: 60s
      timeout: 3s
      retries: 2

  ###########################################
  # Inertia SSR Server
  ###########################################
  ssr:
    build:
      context: .
      dockerfile: ./.docker/app/Dockerfile
      target: development
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    container_name: churchease_ssr
    restart: unless-stopped
    command: node bootstrap/ssr/ssr.js
    environment:
      NODE_ENV: development
    volumes:
      - .:/var/www/app:cached
    networks:
      - churchease-network
    ports:
      - "${SSR_PORT:-13714}:13714"
    deploy:
      resources:
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:13714/healthz || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

###########################################
# Networks
###########################################
networks:
  churchease-network:
    driver: bridge
    name: churchease-network

###########################################
# Volumes
###########################################
volumes:
  postgres_data:
    driver: local
    name: churchease_postgres_data
  redis_data:
    driver: local
    name: churchease_redis_data
  storage_app_data:
    driver: local
    name: churchease_storage_app_data
  mailpit_data:
    driver: local
    name: churchease_mailpit_data
